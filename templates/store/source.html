<!-- 
    MAIN.HTML
 -->
 <!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static  'css/main.css' %}">
    <title>Document</title>
    <script type="text/javascript">
      var  user = '{{request.user}}'
      function getToken(name) {
        var cookieValue = null;
        if (document.cookie) {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getToken('csrftoken');
    function getCookie(name){
      var cookieArr = document.cookie.split(';')
      for (i = 0; i < cookieArr.length; i++ ){
        var cookiePair = cookieArr[i].split('=');
        if (name == cookiePair[0].trim()){
          return decodeURIComponent(cookiePair[1]);
        }
      } 
      return null
    }
    var cart = JSON.parse(getCookie('cart'))
    if (cart == undefined){
      cart = {}
      console.log('Cart was created')
      document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"
    }
    console.log('cart:', cart)    
    </script>
</head>
<body >   
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="{% url 'store' %}">Ecom</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="{% url 'store' %}">Store <span class="sr-only">(current)</span></a>
            </li>
          </ul>  
          <div class="form-inline my-2 my-lg-0">
            <a href="#" class="btn btn-warning"> Login</a>
            <a href="{% url 'cart' %}">
              <img src="{% static 'images/&&.png' %}" id="cart-icon" alt="">
            </a>
            <p id="cart-total">{{cart_items}}</p>
          </div>
        </div>  
    </nav>
    <div class="container">
        {% block content %}

        {% endblock content %}
    </div>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/cart.js' %}"></script>
</body>
</html>



<!-- 
    STORE.HTML
 -->
 {% extends 'store/main.html' %}
{% load static %}
{% block content %}
        <div class="row">
                {% for product in products %}
                <div class="col-lg-4">
                        <img class="thumbnail" src="{{product.imageURL}}" >    
                        <div class="box-element product">   
                                <h6><strong>{{product.name}}</strong></h6>
                                <hr>
                                <button data-product = '{{product.id}}' data-action = 'add' class="btn btn-outline-secondary add-btn update-cart" >add to cart</button>
                                <a href="#" class="btn btn-outline-success">view</a>
                                <h4 style="display: inline-block; float:right"> {{product.price}}$</h4>
                        </div>                        
                </div>
                {% endfor %}
        </div>
{% endblock %}



<!-- 
    CART.HTML
 -->
 {% extends 'store/main.html' %}
 {% load static %}
 {% block content %}
     <div class="row">
         <div class="col-lg-12">
             <div class="box-element">
                 <a href="{% url 'store' %}" class="btn btn-outline-dark"> &#x2190; continue shopping</a>
                 <br>
                 <br>
                 <table class="table">
                     <tr>
                         <th><h5>Items: <strong>{{order.get_cart_items}}</strong></h5></th>
                         <th><h5>Total: <strong>${{order.get_cart_total|floatformat:2}}</strong></h5></th>
                         <th>
                             <a href="{% url 'checkout' %}" class="btn btn-success" style="float: right; margin:5px">checkout</a>
                         </th>
                     </tr> 
                 </table>
             </div>
             <br>
             <br>    
             <div class="box-element">
                 <div class="cart-row">
                     <div style="flex:2 ;"></div>
                     <div style="flex:2 ;"><strong>Items</strong></div>
                     <div style="flex:1 ;"><strong>Price</strong></div>
                     <div style="flex:1 ;"><strong>Quantity</strong></div>
                     <div style="flex:1 ;"><strong>Total</strong></div>
                 </div>
                 {% for item in items %}
                 <div class="cart-row">
                     <div style="flex:2 ;"><img src="{{item.product.imageURL}}" class="row-image" alt=""></div>
                     <div style="flex:2 ;"> {{item.product.name}}</div>
                     <div style="flex:1 ;">{{item.product.price}}$</div>
                     <div style="flex:1 ;">
                         <p class="quantity" id="QT" style="position:relative ;top: -20px;">{{item.quantity}}</p>
                         <div class="quantity">
                                 <img src="{% static 'images/arrow-up.png' %}" data-product='{{item.product.id}}' data-action="add" class="chg-quantity update-cart" alt="" >
                                 <img src="{% static 'images/arrow-down.png' %}" data-product='{{item.product.id}}' data-action="remove" class="chg-quantity update-cart" alt="" >
                                 <img src="" alt="">
                         </div>
                     </div>
                     <div style="flex:1 ;">{{item.get_total}} </div>
                 </div>
                 
                 {% endfor %}
             </div>
         </div>
     </div>
 {% endblock %}



<!-- 
    CHECKOUT.HTML
-->
{% extends 'store/main.html' %}
{% load static %}
{% block content %}
    <div class="row">
        <div class="col-lg-6  ">
            <div class="box-element" id="text-wrapper">
                <form id="form">
                    <div id="user-info">
                        <div class="form-field"><input required type="text" name="name" placeholder="Name.." class="form-control"></div>
                        <div class="form-field"><input required type="email" name="email" placeholder="Email.." class="form-control"></div>
                    </div>
                    <div id="shipping-info">
                        <hr>
                            <p>Shipping information:</p>
                        <hr>
                            <div class="form-field"><input type="text" name="address" required placeholder="Address.."></div>
                            <div class="form-field"><input type="text" name="city" required placeholder="City.."></div>
                            <div class="form-field"><input type="text" name="state" required placeholder="State.."></div>
                            <div class="form-field"><input type="text" name="zipcode" required placeholder="Zip code.."></div>
                    </div>     
                        <hr>
                    <button id="form-button" class="btn btn-success btn-block" type="submit" value="Continue">Continue</button>                   
                </form>
            </div>
            <br>
            <div class="box-element hidden" id="payment-info">
                <small>Paypal Options</small>
                <div id="paypal-button-container"></div>
                <!-- <button id="make-payment">Make payment</button> -->
            </div>
        </div>        
        <div class="col-lg-6">
            <div class="box-element">
                <a href="{% url 'cart' %}" class="btn btn-outline-dark"> &#x2190; Back to cart</a>
                <hr>
                <h3>Order Summary</h3>
                <hr>
                {% for item in items %}
                <div class="cart-row">
                        <div style="flex:2 ;"><img src="{{item.product.imageURL}}" class="row-image" alt=""></div>
                        <div style="flex:2 ;"><p>{{item.product.name}}</p></div>
                        <div style="flex:1 ;"><p>{{item.product.price}}$</p></div>
                        <div style="flex:1 ;"><p>{{item.quantity}}</p></div>                        
                    </div>
                {% endfor %}
                <hr>
                {% if order %}
                <h5>Items: {{order.get_cart_items}}</h5>
                <h5>Total:  {{order.get_cart_total|floatformat:2}}$</h5>
                {% endif  %}
            </div>
        </div>
    </div>
<script src="https://www.paypal.com/sdk/js?client-id=test&currency=USD"></script>
<script>
    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({
        style :{
            'color': 'blue',
            'shape' : 'rect'
        },
        // Call your server to set up the transaction
        createOrder: function(data, actions) {
            return fetch('/demo/checkout/api/paypal/order/create/', {
                method: 'post'
            }).then(function(res) {
                return res.json();
            }).then(function(orderData) {
                return orderData.id;
            });
        },
        // Call your server to finalize the transaction
        onApprove: function(data, actions) {
            return fetch('/demo/checkout/api/paypal/order/' + data.orderID + '/capture/', {
                method: 'post'
            }).then(function(res) {
                return res.json();
            }).then(function(orderData) {
                // Three cases to handle:
                //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                //   (2) Other non-recoverable errors -> Show a failure message
                //   (3) Successful transaction -> Show confirmation or thank you
                // This example reads a v2/checkout/orders capture response, propagated from the server
                // You could use a different API or structure for your 'orderData'
                var errorDetail = Array.isArray(orderData.details) && orderData.details[0];
                if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                    return actions.restart(); // Recoverable state, per:
                    // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
                }
                if (errorDetail) {
                    var msg = 'Sorry, your transaction could not be processed.';
                    if (errorDetail.description) msg += '\n\n' + errorDetail.description;
                    if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
                    return alert(msg); // Show a failure message (try to avoid alerts in production environments)
                }
                // Successful capture! For demo purposes:
                console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                var transaction = orderData.purchase_units[0].payments.captures[0];
                alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');

                // Replace the above to show a success message within this page, e.g.
                // const element = document.getElementById('paypal-button-container');
                // element.innerHTML = '';
                // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                // Or go to another URL:  actions.redirect('thank_you.html');
            });
        }

    }).render('#paypal-button-container');
</script>
<script type="text/javascript">
        var shipping = '{{order.shipping}}'
        var total = '{{order.get_cart_total|floatformat:2}}'
       if (shipping == 'False' ){
           document.getElementById('shipping-info').innerHTML = ''}
       if (user != 'AnonymousUser'){
        document.getElementById('user-info').innerHTML = ''}
       if (shipping == 'False' && user != 'AnonymousUser'){
           document.getElementById('text-wrapper').classList.add('hidden')
           document.getElementById('payment-info').classList.remove('hidden')}
        form = document.getElementById('form')
        form.addEventListener('submit', function(e){
            e.preventDefault()
            document.getElementById('form-button').classList.add('hidden')
            document.getElementById('payment-info').classList.remove('hidden')})
       /* 
        document.getElementById('make-payment').addEventListener('click', function(e){
            submitFormData()})
        */ 
        function submitFormData() {
                console.log('payment button clicked');
                var form = document.getElementById('form');
                var userDataForm = {
                    'name': null,
                    'email': null,
                    'total': total,
                };
                var shippinginfo = {
                    'address': null,
                    'city': null,
                    'state': null,
                    'zipcode': null,
                };
                if (shipping != 'False') {
                    shippinginfo.address = form.address.value;
                    shippinginfo.city = form.city.value;
                    shippinginfo.state = form.state.value;
                    shippinginfo.zipcode = form.zipcode.value;
                }
                if (user == 'AnonymousUser') {
                    userDataForm.name = form.name.value;
                    userDataForm.email = form.email.value;   
                }
                var url = '/process_order/';
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ 'form': userDataForm, 'shipping': shippinginfo })
                })
                .then((response) => {
                    return response.json()
                })
                .then((data) => {
                    console.log('Success:', data);
                    alert('Transaction completed');
                    cart = {}
                    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"
                    window.location.href = "{% url 'store' %}";
                })
            }
</script>
{% endblock %}




<!-- 
    VIEWS.PY
 -->
  from django.shortcuts import render
from django.http import JsonResponse
import json
import datetime
from .models import * 
from .utils import *
# Create your views here.
def store (request):
    data = cartData(request)
    cart_items = data['cart_items']
    order = data['order']
    items = data['items']
    context = {
        'products' : Product.objects.all(),
        'cart_items' : cart_items 
    }
    return render(request, 'store/store.html', context)

def cart (request):
    cookieData =  cartData(request)
    cart_items = cookieData['cart_items']
    order = cookieData['order']
    items = cookieData['items']
    context = {
    'items' : items ,
    'order' : order,       
    'cart_items' : cart_items,
    }
    return render(request, 'store/cart.html', context)

def checkout (request):
    cookieData =  cartData(request)
    cart_items = cookieData['cart_items']
    order = cookieData['order']
    items = cookieData['items']
    context = {
    'items' : items ,
    'order' : order,        
    'cart_items' : cart_items
    }
    return render(request, 'store/checkout.html', context)

def UpdateItem(request):
    data = json.loads(request.body)
    productId = data['productId']
    action = data['action']
    print('action:', action)
    print('product:', productId)
    customer = request.user.customer
    product = Product.objects.get(id = productId)
    order, created = Order.objects.get_or_create(customer = customer, complete = False)
    orderItem, created = OrderItem.objects.get_or_create(order = order, product = product)
    if action == 'add':
        orderItem.quantity = (orderItem.quantity + 1)
    elif action == 'remove':
        orderItem.quantity = (orderItem.quantity - 1)
    orderItem.save()
    if orderItem.quantity <= 0:
        orderItem.delete()
        print ('item was deleted')
    return JsonResponse ('Item was added', safe=False)


def processOrder(request):
    transaction_id = datetime.datetime.now().timestamp()
    data = json.loads(request.body)
    if request.user.is_authenticated:
        customer = request.user.customer
        order, created = Order.objects.get_or_create(customer = customer, complete = False)
    else:
       customer , order = guestOrder(request, data)        
    if order.shipping == True:
            shippingAddress.objects.create(
                customer = customer,
                order = order,
                address = data ['shipping']['address'],
                city = data ['shipping']['city'],
                state = data ['shipping']['state'],
                zipcode = data ['shipping']['zipcode'],
            )
    total = float(data['form']['total'])
    order.transaction_id = transaction_id
    if total == float(order.get_cart_total):
        order.complete = True
    order.save()
    return JsonResponse ('Payment complete!.', safe=False)





<!-- 
    UTILES.PY
 -->

 import json
from .models import *

def cookieCart(request):
    try:
            cart = json.loads(request.COOKIES['cart'])
    except:
            cart = {}
    print('Cart',cart)
    items = []
    order = {"get_cart_items" : 0, 'get_cart_total' : 0, 'shipping' : False}
    cart_items = order['get_cart_items']
    for i in cart:
            try:
                quantity = cart[i]['quantity']
                cart_items +=  quantity
                product = Product.objects.get(id = i)
                total = product.price * cart[i]['quantity']
                order['get_cart_total'] += total
                order['get_cart_items'] +=  quantity
                item = {
                    'product':{
                            'id' : product.id,
                            'name' : product.name,
                            'price' : product.price,
                            'imageURL' : product.imageURL,
                        },
                    'quantity' : cart[i]['quantity'],
                    'get_total': total
                }
                items.append(item)
                if product.digital == False:
                    order['shipping'] = True
            except:
                pass
    return {'items' : items , 'order' : order, 'cart_items' : cart_items}

def cartData (request):
    if request.user.is_authenticated:
        customer = request.user.customer
        order, created = Order.objects.get_or_create(customer = customer, complete = False)
        items = order.orderitem_set.all()
        cart_items = order.get_cart_items
    else:
        cookieData =  cookieCart(request)
        cart_items = cookieData['cart_items']
        order = cookieData['order']
        items = cookieData['items']
    return {"items" : items, 'cart_items' : cart_items, 'order': order}

def guestOrder(request, data):
    print('User is not logged in..')
    print ('COOKIES:', request.COOKIES)
    name = data['form']['name']
    email = data['form']['email']
    cookieData = cookieCart(request)
    items = cookieData['items']
    customer, created = Customer.objects.get_or_create(email = email)
    customer.name = name
    customer.save()
    order = Order.objects.create(
        customer = customer,
        complete = False)    
    for item in items:
        product = Product.objects.get(id = item['product']['id'])
        orderItem = OrderItem.objects.create(
            product = product,
            order = order,
            quantity = item['quantity'])
    return customer, order




<!-- 
    CART.JS
 -->

 var updateBtn = document.getElementsByClassName('update-cart')
for (i = 0; i < updateBtn.length; i++)
{
    updateBtn[i].addEventListener('click', function (){
        var productId = this.dataset.product
        var action = this.dataset.action
        console.log('productId:' , productId, 'action:', action)
        console.log('user:', user)
        if (user == 'AnonymousUser'){
            addCookieItem(productId, action)
        }
        else{
            updatUserOrder(productId, action)
        }
    })
}
function addCookieItem(productId, action) {
    console.log('Not logged in..');
    if (action == 'add') {
        if (cart[productId] == undefined) {
            cart[productId] = {'quantity': 1};
        } 
        else {
            cart[productId]['quantity'] += 1;
        }
    }
    if (action == 'remove') {
        cart[productId]['quantity'] -= 1;
        
        if (cart[productId]['quantity'] <= 0) {
            console.log('Item should be deleted');
            delete cart[productId];
        }
    }
    console.log('cart:', cart);
    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/";
    location.reload()
}

function updatUserOrder(productId,action){ 
        console.log('User is logged in, sending data..')
        var url = '/update_items/'
        fetch (url, {
            method : 'POST',
            headers : {
                'content-type' : 'application/json',
                'X-CSRFToken' : csrftoken,
            },
            body : JSON.stringify({'productId' : productId, 'action' : action})
        })
        .then((Response) => {
            return Response.json()
        })
        .then((data) => {
            console.log('data:', data)
            location.reload()
        })
    }




